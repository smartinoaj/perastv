<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peras TV</title>
  <link rel="icon" type="image/png" href="ptv.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    /* [CSS remains unchanged for layout and style] */
  </style>
</head>
<body>
<div id="passwordScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0e0e11;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;">
  <h2 style="color:white;font-family:'Nunito',sans-serif;">Enter Password</h2>
  <input type="password" id="passwordInput" style="padding:10px;font-size:1em;border-radius:5px;border:none;margin:10px;">
  <button style="padding:10px 20px;font-size:1em;border:none;background-color:#cc2e2e;color:white;border-radius:5px;cursor:pointer;">Enter</button>
  <p id="errorMessage" style="color:red;margin-top:10px;display:none;">Incorrect Password!</p>
</div>
<h1><img src="ptvlogo.png" alt="PERAS TV" style="max-width:250px;height:auto;"></h1>
<div class="tabs">
  <button class="tab-button active" onclick="showTab(event, 'PT')">PT</button>
  <button class="tab-button" onclick="showTab(event, 'UK')">UK</button>
  <button class="tab-button" onclick="showTab(event, 'ES')">ES</button>
  <button class="tab-button" onclick="showTab(event, 'Matches')">Matches</button>
</div>
<div id="PT" class="channel-grid"></div>
<div id="UK" class="channel-grid" style="display:none;"></div>
<div id="ES" class="channel-grid" style="display:none;"></div>
<div id="Matches" class="channel-grid" style="display:none;"></div>
<script>
let ptChannels = [], ukChannels = [], esChannels = [];
fetch("channels.json")
  .then(res => res.json())
  .then(data => {
    const { PT, UK, ES } = data;
    ptChannels = PT; ukChannels = UK; esChannels = ES;
    renderChannels('PT', ptChannels);
    renderChannels('UK', ukChannels);
    renderChannels('ES', esChannels);
  })
  .catch(err => console.error("Failed to load channel data:", err));
fetch("matches.json")
  .then(res => res.json())
  .then(data => renderMatchChannels(data))
  .catch(err => console.error("Failed to load match data:", err));

function renderChannels(tab, channels) {
  const grid = document.getElementById(tab);
  grid.innerHTML = '';
  channels.forEach(({ name, srcs }, index) => {
    const box = document.createElement('div');
    box.className = 'channel-box';
    box.setAttribute('data-index', index);
    const hasM3U8 = srcs.some(src => src.endsWith('.m3u8'));
    box.innerHTML = `<h3>${name}</h3>
      <div class="iframe-container">
        ${hasM3U8 ? '<video id="video-'+tab+'-'+index+'" controls></video>' : '<iframe allow="autoplay; fullscreen" allowfullscreen></iframe>'}
        <div class="stream-buttons">
          ${srcs.map((src, idx) => `<button onclick="changeStream(event, this, '${src}', '${tab}', ${index})">${idx+1}</button>`).join('')}
        </div>
      </div>`;
    box.onclick = () => toggleIframe(box);
    grid.appendChild(box);
  });
}

function renderMatchChannels(matchChannels) {
  const grid = document.getElementById('Matches');
  grid.innerHTML = '';
  matchChannels.forEach(match => {
    const { team1 = "Team 1", team2 = "Team 2", logo1 = "", logo2 = "", time = "", pt = [], uk = [], es = [] } = match;
    const box = document.createElement('div');
    box.className = 'channel-box';
    box.innerHTML = `
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
        <img src="${logo1}" alt="${team1}" style="height: 30px;">
        <h3 style="margin: 0;">${team1} X ${team2}</h3>
        <img src="${logo2}" alt="${team2}" style="height: 30px;">
      </div>
      <p class="match-time">${time}</p>
      <div class="iframe-container">
        <iframe allow="autoplay; fullscreen" allowfullscreen></iframe>
        <div class="stream-buttons">
          ${pt.length ? `<div><strong>PT:</strong> ${pt.map((src, i) => `<button onclick="changeStream(event, this, '${src}', 'Matches')">${i + 1}</button>`).join('')}</div>` : ''}
          ${uk.length ? `<div style="margin-top:5px;"><strong>UK:</strong> ${uk.map((src, i) => `<button onclick="changeStream(event, this, '${src}', 'Matches')">${i + 1}</button>`).join('')}</div>` : ''}
          ${es.length ? `<div style="margin-top:5px;"><strong>ES:</strong> ${es.map((src, i) => `<button onclick="changeStream(event, this, '${src}', 'Matches')">${i + 1}</button>`).join('')}</div>` : ''}
        </div>
      </div>`;
    box.onclick = () => toggleIframe(box);
    grid.appendChild(box);
  });
}

function toggleIframe(box) {
  const container = box.querySelector('.iframe-container');
  const iframe = container.querySelector('iframe');
  const video = container.querySelector('video');
  const isVisible = container.style.display === 'block';
  const grid = box.parentElement;
  document.querySelectorAll('.channel-box').forEach(b => {
    b.classList.remove('expanded');
    const c = b.querySelector('.iframe-container');
    c.style.display = 'none';
    const iframeInside = c.querySelector('iframe');
    if (iframeInside) iframeInside.src = '';
    const videoInside = c.querySelector('video');
    if (videoInside) videoInside.src = '';
  });
  if (!isVisible) {
    box.classList.add('expanded');
    grid.prepend(box);
    const firstButton = container.querySelector('.stream-buttons button');
    if (firstButton) {
      changeStream({ stopPropagation: () => {} }, firstButton, firstButton.getAttribute('onclick').match(/'(.*?)'/)[1], box.dataset.tab || '', box.dataset.index || 0);
    }
    container.style.display = 'block';
  } else {
    const boxes = Array.from(grid.querySelectorAll('.channel-box'));
    boxes.sort((a, b) => parseInt(a.dataset.index) - parseInt(b.dataset.index)).forEach(b => grid.appendChild(b));
  }
}

function changeStream(event, btn, url, tab = '', index = 0) {
  event.stopPropagation();
  const container = btn.closest('.iframe-container');
  const iframe = container.querySelector('iframe');
  const video = container.querySelector('video');
  if (url.endsWith('.m3u8')) {
    if (iframe) iframe.src = '';
    if (Hls.isSupported() && video) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      video.play();
    } else if (video) {
      video.src = url;
      video.play();
    }
  } else {
    if (video) video.src = '';
    if (iframe) iframe.src = url;
  }
  container.querySelectorAll('.stream-buttons button').forEach(button => button.classList.remove('active'));
  btn.classList.add('active');
}

function showTab(event, tabId) {
  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  document.querySelectorAll('.channel-grid').forEach(grid => grid.style.display = 'none');
  document.getElementById(tabId).style.display = 'grid';
}
</script>
<script>
const passwordScreen = document.getElementById('passwordScreen');
const passwordInput = document.getElementById('passwordInput');
const passwordButton = passwordScreen.querySelector('button');
const errorMessage = document.getElementById('errorMessage');
const userPassword = "ptv123";
if (sessionStorage.getItem('authenticated') === 'true') {
  passwordScreen.style.display = 'none';
  document.body.style.overflow = '';
} else {
  document.body.style.overflow = 'hidden';
}
passwordButton.addEventListener('click', verifyPassword);
passwordInput.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') verifyPassword();
});
function verifyPassword() {
  const password = passwordInput.value;
  if (password === userPassword) {
    sessionStorage.setItem('authenticated', 'true');
    passwordScreen.style.display = 'none';
    document.body.style.overflow = '';
  } else {
    errorMessage.style.display = 'block';
    passwordInput.classList.add('shake');
    passwordInput.value = '';
    setTimeout(() => passwordInput.classList.remove('shake'), 500);
  }
}
</script>
<p id="lastUpdated" style="text-align:center; color:#888; font-size:0.85em; margin-top:30px;"></p>
<script>
const lastUpdatedEl = document.getElementById('lastUpdated');
const now = new Date();
lastUpdatedEl.textContent = `Last updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
</script>
</body>
</html>
