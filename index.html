<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IPTV Player (Xtream Codes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .player-wrapper {
            position: relative;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #iptvPlayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
        .sidebar {
            height: calc(100vh - 100px); /* Adjust based on header/footer */
            overflow-y: auto;
        }
        .list-item {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out;
        }
        .list-item:hover, .list-item.active {
            background-color: #2d3748; /* Darker hover/active state */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for webkit browsers */
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4a5568;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-sky-400">Web IPTV Player</h1>
            <p class="text-sm text-gray-400">Connect to Xtream Codes compatible servers</p>
        </header>

        <div id="loginSection" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-xl font-semibold mb-4 text-sky-300">Server Connection</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="serverUrl" class="block text-sm font-medium text-gray-300 mb-1">Server URL (e.g., http://domain.com:port)</label>
                    <input type="text" id="serverUrl" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="http://yourserver.com:8080">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="username" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="YourUsername">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="YourPassword">
                </div>
            </div>
            <button id="connectBtn" class="w-full md:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">Connect</button>
        </div>

        <div id="playerSection" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-sky-300">Categories</h3>
                    <div id="categoriesList" class="sidebar space-y-1 pr-2 max-h-60 md:max-h-full overflow-y-auto">
                        <p class="text-gray-400 text-sm">Connect to a server to see categories.</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-sky-300">Channels</h3>
                    <div id="channelsList" class="sidebar space-y-1 pr-2 max-h-80 md:max-h-full overflow-y-auto">
                        <p class="text-gray-400 text-sm">Select a category to see channels.</p>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2 bg-gray-800 p-1 rounded-lg shadow-lg">
                <div class="player-wrapper">
                    <video id="iptvPlayer" controls autoplay class="rounded-md"></video>
                </div>
                <div id="currentChannelInfo" class="mt-2 text-center text-gray-300">
                    <p>No channel selected.</p>
                </div>
            </div>
        </div>
        <div id="loader" class="hidden loader"></div>
        <div id="messageBox" class="message-box"></div>
    </div>

    <footer class="text-center py-8 mt-10">
        <p class="text-xs text-gray-500">
            Disclaimer: This player is for educational purposes. Ensure you have the legal right to access any content.
            The developers are not responsible for misuse. CORS issues may prevent connection if the server is not configured correctly.
        </p>
    </footer>

    <script>
        // DOM Elements
        const serverUrlInput = document.getElementById('serverUrl');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const connectBtn = document.getElementById('connectBtn');
        const loginSection = document.getElementById('loginSection');
        const playerSection = document.getElementById('playerSection');
        const categoriesList = document.getElementById('categoriesList');
        const channelsList = document.getElementById('channelsList');
        const iptvPlayer = document.getElementById('iptvPlayer');
        const currentChannelInfo = document.getElementById('currentChannelInfo');
        const loader = document.getElementById('loader');
        const messageBox = document.getElementById('messageBox');

        let hls = null; // HLS.js instance
        let currentServerInfo = {}; // To store server, username, password

        // --- Configuration ---
        // Store last used server details in localStorage
        const storedServerUrl = localStorage.getItem('iptv_serverUrl');
        const storedUsername = localStorage.getItem('iptv_username');
        if (storedServerUrl) serverUrlInput.value = storedServerUrl;
        if (storedUsername) usernameInput.value = storedUsername;


        // --- Event Listeners ---
        connectBtn.addEventListener('click', handleConnect);

        // --- Functions ---

        function showMessage(message, type = 'info', duration = 3000) {
            messageBox.textContent = message;
            messageBox.className = 'message-box show'; // Reset classes and add 'show'
            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else { // Default to info
                messageBox.classList.add('bg-sky-500');
            }

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }


        async function handleConnect() {
            const serverUrl = serverUrlInput.value.trim();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!serverUrl || !username || !password) {
                showMessage('Please fill in all server details.', 'error');
                return;
            }

            currentServerInfo = { serverUrl, username, password };
            localStorage.setItem('iptv_serverUrl', serverUrl);
            localStorage.setItem('iptv_username', username);
            // Note: Storing password in localStorage is generally not recommended for production.

            showLoader(true);
            categoriesList.innerHTML = ''; // Clear previous categories
            channelsList.innerHTML = '<p class="text-gray-400 text-sm">Select a category to see channels.</p>'; // Reset channels

            try {
                // Fetch Categories
                const categoriesUrl = `${serverUrl}/player_api.php?username=${username}&password=${password}&action=get_live_categories`;
                console.log('Attempting to fetch categories from:', categoriesUrl); // DEBUG LOG
                const response = await fetch(categoriesUrl);

                if (!response.ok) {
                    // Try to get more specific error from response if possible
                    let errorBody = null;
                    try {
                        errorBody = await response.json(); // Xtream Codes sometimes returns JSON errors
                    } catch (e) { /* ignore if not json */ }

                    if (response.status === 401 && errorBody && errorBody.user_info && errorBody.user_info.auth === 0) {
                         throw new Error('Authentication failed. Please check your credentials.');
                    }
                    throw new Error(`HTTP error! Status: ${response.status} - Could not connect or authenticate.`);
                }
                const categoriesData = await response.json();

                if (categoriesData && Array.isArray(categoriesData) && categoriesData.length > 0) {
                    displayCategories(categoriesData);
                    loginSection.classList.add('hidden');
                    playerSection.classList.remove('hidden');
                    showMessage('Connected successfully! Categories loaded.', 'success');
                } else if (categoriesData && categoriesData.user_info && categoriesData.user_info.auth === 0) {
                     throw new Error('Authentication failed. Please check your credentials.');
                } else if (categoriesData && Array.isArray(categoriesData) && categoriesData.length === 0) {
                    showMessage('Connected, but no live categories found for your account.', 'info', 4000);
                    loginSection.classList.add('hidden'); // Still hide login if connection was "ok" but no data
                    playerSection.classList.remove('hidden');
                    categoriesList.innerHTML = '<p class="text-gray-400 text-sm">No live categories available.</p>';
                }
                else {
                    console.error("Unexpected categoriesData format:", categoriesData);
                    throw new Error('No categories found or an unexpected response format was received.');
                }

            } catch (error) {
                console.error('Error in handleConnect:', error);
                showMessage(`Error: ${error.message}. Check console and ensure server CORS is configured.`, 'error', 7000);
                loginSection.classList.remove('hidden');
                playerSection.classList.add('hidden');
            } finally {
                showLoader(false);
            }
        }

        function displayCategories(categories) {
            categoriesList.innerHTML = ''; // Clear previous
            if (!categories || categories.length === 0) {
                categoriesList.innerHTML = '<p class="text-gray-400 text-sm">No categories available.</p>';
                return;
            }
            categories.forEach(category => {
                if (category.category_id && category.category_name) {
                    const categoryItem = document.createElement('div');
                    categoryItem.classList.add('list-item', 'text-gray-300');
                    categoryItem.textContent = category.category_name;
                    categoryItem.dataset.categoryId = category.category_id;
                    categoryItem.addEventListener('click', () => {
                        // Highlight active category
                        document.querySelectorAll('#categoriesList .list-item').forEach(item => item.classList.remove('active', 'bg-sky-700', 'text-white'));
                        categoryItem.classList.add('active', 'bg-sky-700', 'text-white');
                        loadChannels(category.category_id);
                    });
                    categoriesList.appendChild(categoryItem);
                }
            });
        }

        async function loadChannels(categoryId) {
            if (!currentServerInfo.serverUrl) {
                showMessage('Server information is missing. Please connect again.', 'error');
                return;
            }
            showLoader(true);
            channelsList.innerHTML = '<p class="text-gray-400 text-sm">Loading channels...</p>'; // Clear previous channels

            const { serverUrl, username, password } = currentServerInfo;
            const channelsUrl = `${serverUrl}/player_api.php?username=${username}&password=${password}&action=get_live_streams&category_id=${categoryId}`;
            console.log('Attempting to fetch channels from:', channelsUrl); // DEBUG LOG

            try {
                const response = await fetch(channelsUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const channelsData = await response.json();

                if (channelsData && Array.isArray(channelsData) && channelsData.length > 0) {
                    displayChannels(channelsData);
                } else if (channelsData && Array.isArray(channelsData) && channelsData.length === 0) {
                     channelsList.innerHTML = '<p class="text-gray-400 text-sm">No channels found in this category.</p>';
                } else {
                    console.error("Unexpected channelsData format:", channelsData);
                    channelsList.innerHTML = '<p class="text-red-400 text-sm">Could not load channels (unexpected format).</p>';
                }
            } catch (error) {
                console.error('Error fetching channels:', error);
                showMessage(`Error fetching channels: ${error.message}`, 'error');
                channelsList.innerHTML = `<p class="text-red-400 text-sm">Could not load channels. ${error.message}</p>`;
            } finally {
                showLoader(false);
            }
        }

        function displayChannels(channels) {
            channelsList.innerHTML = ''; // Clear previous
             if (!channels || channels.length === 0) {
                channelsList.innerHTML = '<p class="text-gray-400 text-sm">No channels in this category.</p>';
                return;
            }
            channels.forEach(channel => {
                // Ensure essential properties exist
                if (channel.stream_id !== undefined && channel.name !== undefined) {
                    const channelItem = document.createElement('div');
                    channelItem.classList.add('list-item', 'text-gray-300');
                    channelItem.textContent = channel.name;
                    channelItem.dataset.streamId = channel.stream_id;
                    // Optional: Store other useful data if available
                    if (channel.stream_type) channelItem.dataset.streamType = channel.stream_type;
                    if (channel.epg_channel_id) channelItem.dataset.epgChannelId = channel.epg_channel_id;
                    if (channel.stream_icon) channelItem.dataset.streamIcon = channel.stream_icon;


                    channelItem.addEventListener('click', () => {
                         // Highlight active channel
                        document.querySelectorAll('#channelsList .list-item').forEach(item => item.classList.remove('active', 'bg-sky-600', 'text-white'));
                        channelItem.classList.add('active', 'bg-sky-600', 'text-white');
                        playChannel(channel.stream_id, channel.name, channel.stream_type || 'live'); // Pass stream_type, default to 'live'
                    });
                    channelsList.appendChild(channelItem);
                }
            });
        }

        function playChannel(streamId, channelName, streamType = 'live') { // Added streamType parameter
            if (!currentServerInfo.serverUrl) {
                showMessage('Server information is missing. Please connect again.', 'error');
                return;
            }
            const { serverUrl, username, password } = currentServerInfo;

            // Adjust stream URL based on stream_type (live, movie, series)
            // Common Xtream Codes formats:
            // Live: /live/USERNAME/PASSWORD/STREAM_ID.m3u8 (or .ts)
            // Movie: /movie/USERNAME/PASSWORD/STREAM_ID.mp4 (or .mkv etc.)
            // Series: /series/USERNAME/PASSWORD/STREAM_ID.mp4 (often refers to an episode)
            // Note: HLS.js is primarily for HLS (.m3u8). For direct MP4/MKV, the native <video> tag might work directly
            // without HLS.js, but this example focuses on live HLS streams.
            let streamUrl;
            if (streamType.toLowerCase() === 'movie' || streamType.toLowerCase() === 'series') {
                 // For VOD, the extension is often .mp4, .mkv, etc.
                 // The exact extension might vary by provider.
                 // HLS.js won't play these directly if they are not HLS.
                 // This example primarily supports live .m3u8 streams.
                 // For simplicity, we'll assume VOD might also be offered as .m3u8 by some,
                 // or you'd need a different handling logic for direct MP4/MKV.
                streamUrl = `${serverUrl}/${streamType.toLowerCase()}/${username}/${password}/${streamId}.m3u8`; // Assuming VOD might also be HLS
                // If VOD is typically MP4, you might use:
                // streamUrl = `${serverUrl}/${streamType.toLowerCase()}/${username}/${password}/${streamId}.mp4`;
                // And then handle playback differently (not using HLS.js or checking if native player supports it)
                console.warn(`Playing VOD stream (${streamType}) with .m3u8 extension. This might not work if it's not HLS.`)
            } else { // Default to live
                streamUrl = `${serverUrl}/live/${username}/${password}/${streamId}.m3u8`;
            }


            currentChannelInfo.innerHTML = `<p>Loading: <strong>${channelName}</strong></p>`;
            showMessage(`Attempting to play: ${channelName} (${streamUrl})`, 'info', 4000);
            console.log("Playing stream URL:", streamUrl);


            if (hls) {
                hls.destroy(); // Destroy previous HLS instance
            }

            // Check if the stream is likely HLS based on extension
            if (streamUrl.endsWith('.m3u8') && Hls.isSupported()) {
                hls = new Hls({
                    // Optional HLS.js configurations
                    // capLevelToPlayerSize: true,
                    // maxBufferSize: 30 * 1000 * 1000, // 30MB
                });
                hls.loadSource(streamUrl);
                hls.attachMedia(iptvPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    iptvPlayer.play()
                        .then(() => {
                            currentChannelInfo.innerHTML = `<p>Playing: <strong>${channelName}</strong></p>`;
                            showMessage(`Now playing: ${channelName}`, 'success');
                        })
                        .catch(error => {
                            console.error("Error on iptvPlayer.play():", error);
                            currentChannelInfo.innerHTML = `<p>Error playing: <strong>${channelName}</strong></p>`;
                            showMessage(`Could not play ${channelName}. ${error.message}`, 'error');
                        });
                });
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS.js Error:', data);
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                showMessage(`Network error for ${channelName}. Check URL/CORS. Details: ${data.details}`, 'error', 7000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                showMessage(`Media error for ${channelName}. Stream might be corrupt/incompatible. Details: ${data.details}`, 'error', 7000);
                                if (data.details === 'bufferStalledError' || data.details === 'fragLoadError') {
                                    // hls.recoverMediaError(); // Attempt to recover from some media errors
                                } else {
                                   // hls.destroy(); // For more severe errors
                                }
                                break;
                            default:
                                showMessage(`Error playing ${channelName}. Type: ${data.type}, Details: ${data.details}`, 'error', 7000);
                                // hls.destroy();
                                break;
                        }
                    }
                    currentChannelInfo.innerHTML = `<p>Failed to load: <strong>${channelName}</strong></p>`;
                });
            } else if (iptvPlayer.canPlayType('application/vnd.apple.mpegurl') && streamUrl.endsWith('.m3u8')) {
                // Native HLS support (e.g., Safari) for .m3u8
                iptvPlayer.src = streamUrl;
                iptvPlayer.load(); // Ensure it tries to load the new source
                iptvPlayer.play()
                    .then(() => {
                        currentChannelInfo.innerHTML = `<p>Playing: <strong>${channelName}</strong> (Native)</p>`;
                        showMessage(`Now playing: ${channelName}`, 'success');
                    })
                    .catch(error => {
                         console.error("Error playing video (native HLS):", error);
                        currentChannelInfo.innerHTML = `<p>Error playing: <strong>${channelName}</strong></p>`;
                        showMessage(`Could not play ${channelName} (native). ${error.message}`, 'error');
                    });
                 iptvPlayer.addEventListener('error', (e) => { // Add specific error listener for native playback
                    console.error("Native video element error:", iptvPlayer.error);
                    showMessage(`Video element error for ${channelName}: ${iptvPlayer.error?.message || 'Unknown error'}`, 'error');
                    currentChannelInfo.innerHTML = `<p>Failed to load: <strong>${channelName}</strong></p>`;
                }, { once: true }); // Use once to avoid multiple listeners if channel is re-clicked
            }
            // Basic support for direct MP4 if not m3u8 (VOD example)
            else if ( (streamUrl.endsWith('.mp4') || streamUrl.endsWith('.mkv')) && iptvPlayer.canPlayType(streamUrl.endsWith('.mp4') ? 'video/mp4' : 'video/x-matroska') ) {
                iptvPlayer.src = streamUrl;
                iptvPlayer.load();
                iptvPlayer.play()
                    .then(() => {
                        currentChannelInfo.innerHTML = `<p>Playing VOD: <strong>${channelName}</strong></p>`;
                        showMessage(`Now playing VOD: ${channelName}`, 'success');
                    })
                    .catch(error => {
                        console.error("Error playing VOD (native):", error);
                        currentChannelInfo.innerHTML = `<p>Error playing VOD: <strong>${channelName}</strong></p>`;
                        showMessage(`Could not play VOD ${channelName} (native). ${error.message}`, 'error');
                    });
                iptvPlayer.addEventListener('error', (e) => {
                    console.error("Native VOD video element error:", iptvPlayer.error);
                    showMessage(`VOD Video element error for ${channelName}: ${iptvPlayer.error?.message || 'Unknown error'}`, 'error');
                    currentChannelInfo.innerHTML = `<p>Failed to load VOD: <strong>${channelName}</strong></p>`;
                }, { once: true });
            }
            else {
                showMessage('HLS (.m3u8) is not supported, or stream format is not m3u8/mp4/mkv.', 'error');
                currentChannelInfo.innerHTML = `<p>Cannot play: <strong>${channelName}</strong> (Unsupported format/browser)</p>`;
            }
        }

        function showLoader(show) {
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
