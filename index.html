<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IPTV Player (Xtream Codes)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .player-wrapper { position: relative; padding-top: 56.25%; background-color: #000; border-radius: 0.5rem; overflow: hidden; }
        #iptvPlayer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0.5rem; }
        .sidebar { height: calc(100vh - 120px); overflow-y: auto; } /* Adjusted height */
        .list-item { cursor: pointer; padding: 0.75rem 1rem; border-radius: 0.375rem; transition: background-color 0.2s ease-in-out; }
        .list-item:hover, .list-item.active { background-color: #2d3748; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-track { background: #2d3748; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        .sidebar::-webkit-scrollbar-thumb:hover { background: #718096; }
        .message-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #4a5568; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; opacity: 0; transition: opacity 0.5s ease-in-out; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .message-box.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-sky-400">Web IPTV Player</h1>
            <p class="text-sm text-gray-400">Connect to Xtream Codes compatible servers</p>
        </header>

        <div id="loginSection" class="bg-gray-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-xl font-semibold mb-4 text-sky-300">Server Connection</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="serverUrl" class="block text-sm font-medium text-gray-300 mb-1">Server URL (e.g., http://domain.com:port)</label>
                    <input type="text" id="serverUrl" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="http://yourserver.com:8080">
                </div>
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" id="username" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="YourUsername">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-gray-200 focus:ring-sky-500 focus:border-sky-500" placeholder="YourPassword">
                </div>
            </div>
            <button id="connectBtn" class="w-full md:w-auto bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">Connect</button>
            <p class="mt-3 text-xs text-gray-400">
                Important: If your server URL from other apps is like "http://12345.domain.com", try entering it as "http://domain.com:12345" here.
            </p>
        </div>

        <div id="playerSection" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 bg-gray-800 p-4 rounded-lg shadow-lg">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-sky-300">Categories</h3>
                    <div id="categoriesList" class="sidebar space-y-1 pr-2 max-h-60 md:max-h-[calc(50vh-60px)] overflow-y-auto">
                        <p class="text-gray-400 text-sm">Connect to a server to see categories.</p>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-sky-300">Channels</h3>
                    <div id="channelsList" class="sidebar space-y-1 pr-2 max-h-80 md:max-h-[calc(50vh-60px)] overflow-y-auto">
                         <p class="text-gray-400 text-sm">Select a category to see channels.</p>
                    </div>
                </div>
            </div>
            <div class="md:col-span-2 bg-gray-800 p-1 rounded-lg shadow-lg">
                <div class="player-wrapper">
                    <video id="iptvPlayer" controls autoplay class="rounded-md"></video>
                </div>
                <div id="currentChannelInfo" class="mt-2 text-center text-gray-300">
                    <p>No channel selected.</p>
                </div>
            </div>
        </div>
        <div id="loader" class="hidden loader"></div>
        <div id="messageBox" class="message-box"></div>
    </div>

    <footer class="text-center py-8 mt-10">
        <p class="text-xs text-gray-500">
            Disclaimer: This player is for educational purposes. Ensure you have the legal right to access any content.
            CORS or Mixed Content issues may prevent connection if the server/player hosting is not configured correctly.
        </p>
    </footer>

    <script>
        const serverUrlInput = document.getElementById('serverUrl');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const connectBtn = document.getElementById('connectBtn');
        const loginSection = document.getElementById('loginSection');
        const playerSection = document.getElementById('playerSection');
        const categoriesList = document.getElementById('categoriesList');
        const channelsList = document.getElementById('channelsList');
        const iptvPlayer = document.getElementById('iptvPlayer');
        const currentChannelInfo = document.getElementById('currentChannelInfo');
        const loader = document.getElementById('loader');
        const messageBox = document.getElementById('messageBox');

        let hls = null;
        let currentServerInfo = {};

        const storedServerUrl = localStorage.getItem('iptv_serverUrl');
        const storedUsername = localStorage.getItem('iptv_username');
        if (storedServerUrl) serverUrlInput.value = storedServerUrl;
        if (storedUsername) usernameInput.value = storedUsername;

        connectBtn.addEventListener('click', handleConnect);

        function showMessage(message, type = 'info', duration = 3000) {
            messageBox.textContent = message;
            messageBox.className = 'message-box show';
            if (type === 'error') messageBox.classList.add('bg-red-700');
            else if (type === 'success') messageBox.classList.add('bg-green-600');
            else messageBox.classList.add('bg-sky-600');
            setTimeout(() => messageBox.classList.remove('show'), duration);
        }

        function showLoader(show) {
            loader.classList.toggle('hidden', !show);
        }

        async function fetchApi(baseUrl, params) {
            const url = new URL(baseUrl);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            
            console.log(`Attempting to fetch: ${url.toString()}`);
            try {
                const response = await fetch(url.toString());
                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) { /* no json error body */ }

                    if (response.status === 401 && errorData && errorData.user_info && errorData.user_info.auth === 0) {
                        throw new Error('Authentication failed. Check credentials.');
                    }
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                // Log the error and rethrow a more specific error if it's a TypeError (often network/DNS related)
                console.error(`Fetch API error for ${url.toString()}:`, error);
                if (error instanceof TypeError && error.message.includes('failed to fetch')) { // Common for DNS/Network/CORS
                    throw new Error(`Network error (DNS, CORS, or server down) for ${url.host}. Details: ${error.message}`);
                }
                throw error; // Rethrow other errors (like auth or HTTP status)
            }
        }

        async function handleConnect() {
            let serverUrl = serverUrlInput.value.trim();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!serverUrl || !username || !password) {
                showMessage('Please fill in all server details.', 'error');
                return;
            }
            
            // Normalize serverUrl: remove trailing slash if present
            if (serverUrl.endsWith('/')) {
                serverUrl = serverUrl.slice(0, -1);
            }

            currentServerInfo = { serverUrl, username, password };
            localStorage.setItem('iptv_serverUrl', serverUrl);
            localStorage.setItem('iptv_username', username);

            showLoader(true);
            categoriesList.innerHTML = '';
            channelsList.innerHTML = '<p class="text-gray-400 text-sm">Select a category to see channels.</p>';

            const apiParams = { username, password, action: 'get_live_categories' };
            let categoriesData;

            try {
                // Try HTTPS first
                console.log("Attempting HTTPS API call...");
                const httpsApiUrl = serverUrl.startsWith('http://') 
                                   ? serverUrl.replace('http://', 'https://') + '/player_api.php'
                                   : (serverUrl.startsWith('https://') ? serverUrl : 'https://' + serverUrl) + '/player_api.php';
                
                categoriesData = await fetchApi(httpsApiUrl, apiParams);

            } catch (httpsError) {
                console.warn(`HTTPS connection to ${serverUrl} failed: ${httpsError.message}. Trying HTTP...`);
                if (window.location.protocol === 'https:') {
                     showMessage('HTTPS failed. Trying HTTP (may cause mixed content issues).', 'info', 4000);
                }
                try {
                    const httpApiUrl = serverUrl.startsWith('https://')
                                     ? serverUrl.replace('https://', 'http://') + '/player_api.php'
                                     : (serverUrl.startsWith('http://') ? serverUrl : 'http://' + serverUrl) + '/player_api.php';

                    categoriesData = await fetchApi(httpApiUrl, apiParams);
                } catch (httpError) {
                    console.error('Both HTTPS and HTTP connection attempts failed.');
                    showMessage(`Connection error: ${httpError.message}. Check URL, port, DNS, and CORS.`, 'error', 7000);
                    loginSection.classList.remove('hidden');
                    playerSection.classList.add('hidden');
                    showLoader(false);
                    return;
                }
            }

            showLoader(false);
            if (categoriesData && Array.isArray(categoriesData) && categoriesData.length > 0) {
                displayCategories(categoriesData);
                loginSection.classList.add('hidden');
                playerSection.classList.remove('hidden');
                showMessage('Connected! Categories loaded.', 'success');
            } else if (categoriesData && categoriesData.user_info && categoriesData.user_info.auth === 0) {
                showMessage('Authentication failed. Check credentials.', 'error');
            } else if (categoriesData && Array.isArray(categoriesData) && categoriesData.length === 0) {
                showMessage('Connected, but no live categories found.', 'info');
                loginSection.classList.add('hidden');
                playerSection.classList.remove('hidden');
                categoriesList.innerHTML = '<p class="text-gray-400 text-sm">No live categories.</p>';
            } else {
                showMessage('No categories or unexpected response.', 'error');
                console.error("Unexpected categoriesData:", categoriesData);
            }
        }

        function displayCategories(categories) {
            categoriesList.innerHTML = '';
            categories.forEach(category => {
                if (category.category_id && category.category_name) {
                    const item = document.createElement('div');
                    item.classList.add('list-item', 'text-gray-300');
                    item.textContent = category.category_name;
                    item.dataset.categoryId = category.category_id;
                    item.addEventListener('click', (e) => {
                        document.querySelectorAll('#categoriesList .list-item').forEach(el => el.classList.remove('active', 'bg-sky-700', 'text-white'));
                        e.currentTarget.classList.add('active', 'bg-sky-700', 'text-white');
                        loadChannels(category.category_id);
                    });
                    categoriesList.appendChild(item);
                }
            });
        }

        async function loadChannels(categoryId) {
            showLoader(true);
            channelsList.innerHTML = '<p class="text-gray-400 text-sm">Loading channels...</p>';
            const { serverUrl, username, password } = currentServerInfo;
            const apiParams = { username, password, action: 'get_live_streams', category_id: categoryId };
            let channelsData;

            try {
                 // Determine protocol from original serverUrl for consistency or try HTTPS first
                const baseApiUrl = (serverUrl.startsWith('https://') ? serverUrl : serverUrl.replace('http://', 'https://')) + '/player_api.php';
                try {
                    channelsData = await fetchApi(baseApiUrl, apiParams);
                } catch (httpsError) {
                    console.warn(`HTTPS for channels failed: ${httpsError.message}. Trying HTTP.`);
                    const httpFallbackApiUrl = (serverUrl.startsWith('http://') ? serverUrl : serverUrl.replace('https://', 'http://')) + '/player_api.php';
                    channelsData = await fetchApi(httpFallbackApiUrl, apiParams);
                }

                if (channelsData && Array.isArray(channelsData) && channelsData.length > 0) {
                    displayChannels(channelsData);
                } else {
                    channelsList.innerHTML = '<p class="text-gray-400 text-sm">No channels in this category.</p>';
                }
            } catch (error) {
                showMessage(`Error fetching channels: ${error.message}`, 'error');
                channelsList.innerHTML = `<p class="text-red-400 text-sm">Could not load channels.</p>`;
            } finally {
                showLoader(false);
            }
        }

        function displayChannels(channels) {
            channelsList.innerHTML = '';
            channels.forEach(channel => {
                if (channel.stream_id !== undefined && channel.name !== undefined) {
                    const item = document.createElement('div');
                    item.classList.add('list-item', 'text-gray-300');
                    item.textContent = channel.name;
                    item.addEventListener('click', (e) => {
                        document.querySelectorAll('#channelsList .list-item').forEach(el => el.classList.remove('active', 'bg-sky-600', 'text-white'));
                        e.currentTarget.classList.add('active', 'bg-sky-600', 'text-white');
                        playChannel(channel.stream_id, channel.name, channel.stream_type || 'live');
                    });
                    channelsList.appendChild(item);
                }
            });
        }

        function playChannel(streamId, channelName, streamType = 'live') {
            const { serverUrl, username, password } = currentServerInfo;
            let streamProtocol = serverUrl.startsWith('https://') ? 'https://' : 'http://';
            
            // If player page is HTTPS, try to use HTTPS for streams if serverUrl was HTTP.
            if (window.location.protocol === 'https:' && streamProtocol === 'http://') {
                console.log("Player on HTTPS, attempting HTTPS for stream URL");
                streamProtocol = 'https://';
            }
            
            const SUrl = serverUrl.replace(/^https?:\/\//, ''); // Remove existing protocol for reconstruction

            let fullStreamUrl = `${streamProtocol}${SUrl}/${streamType.toLowerCase()}/${username}/${password}/${streamId}.m3u8`;
            
            // For some VOD, it might be .mp4 or other extensions
            if (streamType.toLowerCase() === 'movie' || streamType.toLowerCase() === 'series_old_vod_format') { // Made up a different type to avoid m3u8 default
                // This part needs more robust handling based on actual VOD stream types from your provider
                // For now, we assume HLS for VOD too, but this is often not the case.
                // fullStreamUrl = `${streamProtocol}${SUrl}/movie/${username}/${password}/${streamId}.mp4`; // Example for MP4 VOD
            }


            currentChannelInfo.innerHTML = `<p>Loading: <strong>${channelName}</strong></p>`;
            showMessage(`Playing: ${channelName}`, 'info', 2000);
            console.log("Attempting to play stream URL:", fullStreamUrl);

            if (hls) hls.destroy();

            if (fullStreamUrl.endsWith('.m3u8') && Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(fullStreamUrl);
                hls.attachMedia(iptvPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    iptvPlayer.play().catch(e => {
                        console.error("Player.play() error:", e);
                        showMessage(`Could not auto-play ${channelName}. ${e.message}`, 'error');
                    });
                    currentChannelInfo.innerHTML = `<p>Playing: <strong>${channelName}</strong></p>`;
                });
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS.js Error:', data);
                    showMessage(`HLS Error for ${channelName}: ${data.details || data.type}`, 'error', 5000);
                    currentChannelInfo.innerHTML = `<p>Failed to load: <strong>${channelName}</strong></p>`;
                });
            } else if (iptvPlayer.canPlayType('application/vnd.apple.mpegurl') && fullStreamUrl.endsWith('.m3u8')) {
                iptvPlayer.src = fullStreamUrl;
                iptvPlayer.play().catch(e => {
                    console.error("Native Player.play() error:", e);
                    showMessage(`Could not auto-play ${channelName} (native). ${e.message}`, 'error');
                });
                currentChannelInfo.innerHTML = `<p>Playing: <strong>${channelName}</strong> (Native)</p>`;
            } else {
                showMessage('HLS (.m3u8) not supported or invalid stream URL.', 'error');
                currentChannelInfo.innerHTML = `<p>Cannot play: <strong>${channelName}</strong></p>`;
            }
        }
    </script>
</body>
</html>
