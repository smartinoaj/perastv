<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Peras TV</title>
  <link rel="icon" type="image/png" href="ptv.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { margin:0; padding:0; background:#0e0e11; color:#fff; font-family:Arial,sans-serif; }
    h1 { text-align:center; padding:20px; font-size:2.5em; font-family:'Nunito',sans-serif; }
    .tabs { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
    .tab-button { background:#1e1e22; color:#fff; border:none; padding:10px 20px; cursor:pointer; border-radius:8px; }
    .tab-button.active { background:#cc2e2e; }
    .channel-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px; padding:0 20px 40px; max-width:1200px; margin:0 auto; }
    .channel-box { background:#1e1e22; border-radius:10px; padding:15px; cursor:pointer; transition:all .3s; text-align:center; display:flex; flex-direction:column; align-items:center; min-height:80px; }
    .channel-box h3 { margin:0; font-size:1.2em; font-weight:600; }
    .video-container { margin-top:10px; display:none; width:100%; }
    .video-container video { width:100%; aspect-ratio:16/9; border:none; border-radius:10px; object-fit:contain; }
    .stream-buttons { margin-top:10px; display:flex; justify-content:center; flex-wrap:wrap; }
    .stream-buttons button { background:#333; color:#fff; border:none; padding:5px 10px; margin:0 3px; border-radius:5px; cursor:pointer; }
    .stream-buttons button.active { background:#cc2e2e; }
    .shake { animation: shake .3s; }
    @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)} }
    .channel-box.expanded { grid-column:1/-1; background:#2a2a2f; z-index:2; position:relative; box-shadow:0 0 20px rgba(0,0,0,.5); }
    .channel-box.expanded .video-container video { min-height:480px; }
    .match-time { margin:5px 0 10px; font-size:.95em; color:#ccc; text-align:center; }
    #Matches.channel-grid { display:flex!important; flex-direction:column; align-items:center; gap:25px; max-width:1000px; margin:0 auto; }
    @media (max-width:600px) {
      .channel-box.expanded .video-container video { min-height:220px; }
    }
  </style>
</head>
<body>
  <!-- Password Screen -->
  <div id="passwordScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#0e0e11;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;">
    <h2 style="color:#fff;font-family:'Nunito',sans-serif;">Enter Password</h2>
    <input type="password" id="passwordInput" style="padding:10px;font-size:1em;border-radius:5px;border:none;margin:10px;">
    <button style="padding:10px 20px;font-size:1em;border:none;background:#cc2e2e;color:#fff;border-radius:5px;cursor:pointer;">Enter</button>
    <p id="errorMessage" style="color:red;display:none;margin-top:10px;">Incorrect Password!</p>
  </div>

  <h1><img src="ptvlogo.png" alt="PERAS TV" style="max-width:250px;"></h1>

  <div class="tabs">
    <button class="tab-button active" onclick="showTab(event,'PT')">PT</button>
    <button class="tab-button" onclick="showTab(event,'UK')">UK</button>
    <button class="tab-button" onclick="showTab(event,'ES')">ES</button>
    <button class="tab-button" onclick="showTab(event,'Matches')">Matches</button>
  </div>

  <div id="PT" class="channel-grid"></div>
  <div id="UK" class="channel-grid" style="display:none;"></div>
  <div id="ES" class="channel-grid" style="display:none;"></div>
  <div id="Matches" class="channel-grid" style="display:none;"></div>

  <script>
    let ptChannels = [], ukChannels = [], esChannels = [], hls = null;

    // Load JSON data
    fetch("channels.json")
      .then(r => r.json())
      .then(d => {
        ptChannels = d.PT; ukChannels = d.UK; esChannels = d.ES;
        renderChannels("PT", ptChannels);
        renderChannels("UK", ukChannels);
        renderChannels("ES", esChannels);
      })
      .catch(err => console.error("Channel load error:", err));

    fetch("matches.json")
      .then(r => r.json())
      .then(renderMatchChannels)
      .catch(err => console.error("Match load error:", err));

    function renderChannels(tab, list) {
      const grid = document.getElementById(tab);
      grid.innerHTML = "";
      list.forEach(({name, srcs}, idx) => {
        const box = document.createElement("div");
        box.className = "channel-box";
        box.innerHTML = `
          <h3>${name}</h3>
          <div class="video-container">
            <video controls autoplay muted playsinline></video>
            <div class="stream-buttons">
              ${srcs.map((url,i)=>`<button onclick="changeStream(event,this,'${url}')">${i+1}</button>`).join("")}
            </div>
          </div>`;
        box.onclick = () => toggleVideo(box);
        grid.appendChild(box);
      });
    }

    function renderMatchChannels(matches) {
      const grid = document.getElementById("Matches");
      grid.innerHTML = "";
      matches.forEach(m => {
        const {team1,team2,logo1="",logo2="",time="",pt=[],uk=[],es=[]} = m;
        const box = document.createElement("div");
        box.className = "channel-box";
        box.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;">
            <img src="${logo1}" alt="${team1}" style="height:30px;">
            <h3 style="margin:0;">${team1} X ${team2}</h3>
            <img src="${logo2}" alt="${team2}" style="height:30px;">
          </div>
          <p class="match-time">${time}</p>
          <div class="video-container">
            <video controls autoplay muted playsinline></video>
            <div class="stream-buttons">
              ${pt.length?`<div><strong>PT:</strong> ${pt.map((u,i)=>`<button onclick="changeStream(event,this,'${u}')">${i+1}</button>`).join("")}</div>`:""}
              ${uk.length?`<div style="margin-top:5px;"><strong>UK:</strong> ${uk.map((u,i)=>`<button onclick="changeStream(event,this,'${u}')">${i+1}</button>`).join("")}</div>`:""}
              ${es.length?`<div style="margin-top:5px;"><strong>ES:</strong> ${es.map((u,i)=>`<button onclick="changeStream(event,this,'${u}')">${i+1}</button>`).join("")}</div>`:""}
            </div>
          </div>`;
        box.onclick = () => toggleVideo(box);
        grid.appendChild(box);
      });
    }

    function toggleVideo(box) {
      const cont = box.querySelector(".video-container"),
            vid  = cont.querySelector("video"),
            showing = cont.style.display === "block";
      // collapse all
      document.querySelectorAll(".channel-box").forEach(b=>{
        b.classList.remove("expanded");
        const c = b.querySelector(".video-container"), v = c.querySelector("video");
        c.style.display = "none";
        if(hls){hls.destroy(); hls=null;}
        v.src = "";
      });
      if(!showing){
        box.classList.add("expanded");
        box.parentElement.prepend(box);
        const btn = cont.querySelector(".stream-buttons button");
        changeStream({stopPropagation:()=>{}}, btn, btn.getAttribute("onclick").match(/'(.+)'/)[1]);
        cont.style.display = "block";
      }
    }

    function changeStream(ev, btn, url) {
      ev.stopPropagation();
      const cont = btn.closest(".video-container"),
            vid  = cont.querySelector("video");
      if(hls){ hls.destroy(); hls=null; }
      vid.src = "";
      if(Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(vid);
      } else if(vid.canPlayType("application/vnd.apple.mpegURL")){
        vid.src = url;
      }
      cont.querySelectorAll(".stream-buttons button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }

    function showTab(e,id){
      document.querySelectorAll(".tab-button").forEach(b=>b.classList.remove("active"));
      e.target.classList.add("active");
      document.querySelectorAll(".channel-grid").forEach(g=>g.style.display="none");
      document.getElementById(id).style.display = id==="Matches"?"flex":"grid";
    }
  </script>

  <!-- Password logic -->
  <script>
    const pwScreen = document.getElementById("passwordScreen"),
          pwInput  = document.getElementById("passwordInput"),
          errMsg   = document.getElementById("errorMessage"),
          pwButton = pwScreen.querySelector("button"),
          secret   = "ptv123";
    if(sessionStorage.getItem("authenticated")==="true"){
      pwScreen.style.display="none"; document.body.style.overflow="";
    } else {
      document.body.style.overflow="hidden";
    }
    pwButton.onclick = verify;
    pwInput.onkeydown = e=> e.key==="Enter" && verify();
    function verify(){
      if(pwInput.value===secret){
        sessionStorage.setItem("authenticated","true");
        pwScreen.style.display="none"; document.body.style.overflow="";
      } else {
        errMsg.style.display="block";
        pwInput.classList.add("shake");
        pwInput.value="";
        setTimeout(()=>pwInput.classList.remove("shake"),500);
      }
    }
  </script>

  <!-- Last updated -->
  <p id="lastUpdated" style="text-align:center;color:#888;font-size:.85em;margin-top:30px;"></p>
  <script>
    const upd = document.getElementById("lastUpdated"),
          now = new Date();
    upd.textContent = `Last updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
  </script>
</body>
</html>
